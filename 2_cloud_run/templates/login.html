{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="login-page">
    <div class="card login-card">
        <h2 class="text-center">Welcome</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="you@example.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
            <button type="submit" class="btn">Sign In</button>
        </form>
        <button id="google-signin-btn" class="btn btn-google">Sign in with Google</button>
        <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
            For account creation or password changes, contact <a
                href="mailto:admin@example.com?subject=Account%20Support%20Request&body=Hello%2C%0A%0AI%20would%20like%20to%20request%20assistance%20with%3A%0A%0A%5BPlease%20select%20one%5D%0A-%20New%20account%20creation%0A-%20Password%20reset%2Fchange%0A%0AThank%20you%20for%20your%20help.">admin@example.com</a>

        </p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        connectAuthEmulator
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    const firebaseConfig = {{ firebase_config | tojson }};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Connect to emulator only in local development
    // In production, window.location.hostname will be your actual domain
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('ðŸ”§ Development mode: Connecting to Firebase Auth emulator');
        connectAuthEmulator(auth, "http://localhost:9099", { disableWarnings: true });
    }

    const provider = new GoogleAuthProvider();

    const handleSessionCreation = async (user, btn, originalText) => {
        try {
            const idToken = await user.getIdToken();

            // Send token to FastAPI to set a secure HTTP-only cookie
            const response = await fetch('{{ root_path }}/auth/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: idToken })
            });

            if (response.ok) {
                window.location.href = '{{ root_path }}/dashboard';
            } else {
                const errorData = await response.json();
                alert('Failed to create session: ' + (errorData.detail || 'Unknown error'));
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        } catch (error) {
            console.error(error);
            alert('Session creation failed: ' + error.message);
            if (btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    };

    document.getElementById('google-signin-btn').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            await handleSessionCreation(result.user, null, null);
        } catch (error) {
            console.error(error);
            alert('Google Sign-In failed: ' + error.message);
        }
    };

    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = 'Signing in...';
        btn.disabled = true;

        try {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            await handleSessionCreation(userCredential.user, btn, originalText);
        } catch (error) {
            console.error(error);
            alert('Login failed: ' + error.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };
</script>
{% endblock %}
